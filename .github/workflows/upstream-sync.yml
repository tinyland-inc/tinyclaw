# Reference project check: compares our main branch against a reference project.
# Copy this to .github/workflows/upstream-sync.yml in each agent repo.
#
# Since repos are standalone (not GitHub forks), this workflow fetches the
# reference project directly. Agent-mediated campaigns (oc-upstream-sync,
# pc-upstream-sync) are the primary mechanism; this is a manual fallback.
#
# Set REFERENCE_REPO secret or variable to the reference project (e.g., openclaw/openclaw).
name: Reference Sync

on:
  workflow_dispatch:
    inputs:
      reference_repo:
        description: 'Reference repo (e.g., openclaw/openclaw)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Check reference project
    runs-on: ubuntu-latest
    env:
      REF_REPO: ${{ inputs.reference_repo || vars.REFERENCE_REPO || '' }}
    steps:
      - name: Validate reference repo
        if: env.REF_REPO == ''
        run: |
          echo "::error::No reference repo specified. Set REFERENCE_REPO variable or pass via workflow_dispatch input."
          exit 1

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Add reference remote
        run: |
          git remote add reference "https://github.com/${{ env.REF_REPO }}.git" || true
          git fetch reference main

      - name: Compare and report
        id: compare
        run: |
          # Count commits in reference that aren't in our main
          AHEAD=$(git rev-list HEAD..reference/main --count 2>/dev/null || echo "0")
          echo "Reference project is ${AHEAD} commits ahead"
          echo "ahead=${AHEAD}" >> "$GITHUB_OUTPUT"

          if [ "$AHEAD" = "0" ]; then
            echo "status=current" >> "$GITHUB_OUTPUT"
          else
            echo "status=behind" >> "$GITHUB_OUTPUT"
            echo ""
            echo "Recent reference commits not in our main:"
            git log HEAD..reference/main --oneline --max-count=20
          fi

      - name: Create tracking issue if behind
        if: steps.compare.outputs.status == 'behind' && steps.compare.outputs.ahead != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AHEAD=${{ steps.compare.outputs.ahead }}
          COMMITS=$(git log HEAD..reference/main --oneline --max-count=20)
          gh issue create \
            --title "Reference sync: ${AHEAD} commits to evaluate from ${{ env.REF_REPO }}" \
            --body "$(cat <<EOF
          The reference project (\`${{ env.REF_REPO }}\`) has **${AHEAD}** commits not in our main branch.

          ## Recent commits to evaluate
          \`\`\`
          ${COMMITS}
          \`\`\`

          Review these changes and selectively adopt any that are relevant to our deployment.
          Agent campaigns (oc-upstream-sync / pc-upstream-sync) handle this automatically.
          EOF
          )" \
            --label "reference-sync"
